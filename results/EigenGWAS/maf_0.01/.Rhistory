library(GAPIT)
library(dplyr)
library(ggplot2)
setwd("/home/mie/Schreibtisch/Unistuff/Master/Semester2/Forschungsgruppenpraktikum_Steven/Test_Git")
MAFs <- c(.01,.05)
limits_by_maf <- list(
`0.01` = c(150, 500, 250),
`0.05` = c(120, 400, 200)
)
for (MAF in MAFs) {
myG <- read.table(paste0("data/hmp_TASSEL/mygenotypes_maf",MAF,".hmp.txt"),
sep="\t",
comment.char = "",
header = FALSE)
myG[,3] <- sub("(?i)^(?:chr)?([1-7])r$", "\\1", myG[,3], perl = TRUE)
myG[,3] <- sub("(?i)^un$", "8", myG[,3], perl = TRUE)
myG[,3] <- sub("(?i)^b$", "9", myG[,3], perl = TRUE)
limit <- limits_by_maf[[format(MAF, scientific = FALSE)]]
maf_str <- sprintf(".%02d", MAF * 100)
myY_raw <- read.table(paste0("data/pca_PLINK/maf",maf_str,"_minDP20_maxDP100_minQ40_missing.90.biallelic.eigenvec"), head = FALSE)
keep <- c(1, 3:min(5, ncol(myY_raw)))
myY <- myY_raw[, keep, drop = FALSE]
colnames(myY) <- c("Taxa", paste0("PC", seq_len(ncol(myY)-1)))
Y  <- myY
setwd(paste0("results/EigenGWAS/maf_",MAF))
con <- file(sprintf("gapit_%s.log", format(Sys.time(), "%Y%m%d")), open = "wt")
sink(con, split = TRUE)
sink(con, type = "message")
gapit_ok <- tryCatch({
myGAPIT <- GAPIT(
Y = Y,
G = myG,
PCA.total = 0,
model = "FarmCPU",
SNP.MAF = 0,
file.output = TRUE
)
TRUE
}, error = function(e) {
message("GAPIT error (ignored): ", conditionMessage(e))
FALSE
}, finally = {
# wird IMMER ausgeführt – auch bei error
sink(type = "message")
sink()
close(con)
})
# eigener Plot mit den p = 0 Makern
manhattan_EigenGWAS <- function(alpha = 0.01, title, limits, PC = 0) {
df <- read.csv(paste0("GAPIT.Association.GWAS_Results.FarmCPU.PC",PC,"(NYC).csv"),
header = TRUE)
df <- df %>% mutate(Significant = P.value < alpha/nrow(df))
df <- df %>% mutate(minusLog10P = -log10(P.value))
df$minusLog10P[df$P.value == 0] <- 500
df$Chr <- factor(
df$Chr,
levels = as.character(1:9),
labels = c(paste0("chr", 1:7, "R"), "chrUn", "chrB")
)
ggplot(df, aes(x = Pos, y = minusLog10P , color = Significant)) +
geom_point(alpha = 1, size = 0.8) +
scale_color_manual(values = c("FALSE" = "darkgrey", "TRUE" = "#4DAF4A")) +
facet_wrap(~Chr, scales = "free_x", ncol = 4) +
labs(
x = "Genom position (Mbp)",
y = expression(-log[10](p)),
title = title,
color = paste0("Significance\n(alpha = ", alpha, ",\n Bonferroni)")
) +
scale_x_continuous(
labels = function(x) x / 1e6
) +
coord_cartesian(ylim = limits) +
theme_bw() +
theme(
strip.text = element_text(size = 9),
axis.text.x = element_text(size = 6, angle = 45, hjust = 1),
axis.text.y = element_text(size = 6),
legend.position = c(0.9, 0.1),
legend.justification = c(1, 0.5)
)
}
for(PC in 1:3){
p <- manhattan_EigenGWAS(PC = PC, limits = c(0,limit[PC]),
title = paste0("PC", PC, ", MAF = ",MAF,", Model = FarmCPU"))
pdf(paste0("manhatten_PC",PC,"_GAPIT_maf",MAF,".pdf"),
width = 10, height = 5)
print(p)
dev.off()
}
}
gc()
gc()
